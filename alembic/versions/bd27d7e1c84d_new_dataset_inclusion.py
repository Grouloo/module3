"""New dataset inclusion

Revision ID: bd27d7e1c84d
Revises: ad27d7e1c84d
Create Date: 2025-12-05 01:16:58.882296

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.orm import Session
import pandas as pd
from domain.loans.loan import Loan
import statistics

# revision identifiers, used by Alembic.
revision: str = 'bd27d7e1c84d'
down_revision: Union[str, Sequence[str], None] = 'ad27d7e1c84d'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('loans', sa.Column('nb_enfants', sa.Integer(), nullable=True)) 
    op.add_column('loans', sa.Column('quotient_caf', sa.Integer(), nullable=True))

    raw_dataset = pd.read_csv("data/migration_dataset.csv")

    raw_dataset["date_creation_compte"] =  pd.to_datetime(raw_dataset['date_creation_compte'])
    raw_dataset["date_creation_compte"] =  raw_dataset["date_creation_compte"].apply(lambda x: x.timestamp())
       

    # Mise en conformité
    final_dataset = raw_dataset.copy()

    final_dataset["imc"] = final_dataset.apply(lambda x: x["poids"] / ((x["taille"] / 100) ** 2), axis=1)

    final_dataset = final_dataset.drop(columns=["orientation_sexuelle", "nom", "prenom", "sexe", "nationalité_francaise", "taille", "poids", "region"])

    session = Session(bind=op.get_bind())
    last = session.query(Loan).order_by(Loan.id.desc()).first()
    last_id = last.id

    final_dataset["id"] = final_dataset.index.map(lambda x: x + last_id + 1)

    final_dataset.to_sql("loans", op.get_bind(), if_exists="append", index=False)


    # Imputation des nouvelles colonnes pour les lignes existantes
    every_nb_enfant = [
        loan.nb_enfants 
        for loan in session.query(Loan.nb_enfants).filter(Loan.nb_enfants.isnot(None))
    ]
    median_nb_enfants = int(statistics.median(every_nb_enfant))
    session.query(Loan).update(
        {Loan.nb_enfants: median_nb_enfants},
        synchronize_session=False  
    )

    every_quotient_caf = [
        loan.quotient_caf 
        for loan in session.query(Loan.quotient_caf).filter(Loan.quotient_caf.isnot(None))
    ]
    median_quotient_caf = int(statistics.median(every_quotient_caf))
    session.query(Loan).update(
        {Loan.quotient_caf: median_quotient_caf},
        synchronize_session=False  
    )

    session.commit()
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('loans',
    sa.Column('id', sa.BIGINT(), nullable=True),
    sa.Column('age', sa.BIGINT(), nullable=True),
    sa.Column('sport_licence', sa.TEXT(), nullable=True),
    sa.Column('niveau_etude', sa.TEXT(), nullable=True),
    sa.Column('smoker', sa.TEXT(), nullable=True),
    sa.Column('revenu_estime_mois', sa.BIGINT(), nullable=True),
    sa.Column('situation_familiale', sa.TEXT(), nullable=True),
    sa.Column('historique_credits', sa.FLOAT(), nullable=True),
    sa.Column('risque_personnel', sa.FLOAT(), nullable=True),
    sa.Column('date_creation_compte', sa.FLOAT(), nullable=True),
    sa.Column('score_credit', sa.FLOAT(), nullable=True),
    sa.Column('loyer_mensuel', sa.FLOAT(), nullable=True),
    sa.Column('montant_pret', sa.FLOAT(), nullable=True),
    sa.Column('imc', sa.FLOAT(), nullable=True)
    )
    op.create_index(op.f('ix_loans_id'), 'loans', ['id'], unique=False)
    # ### end Alembic commands ###
